<?php
/**
 * @file
 * Main module code for the Group project.
 */

/**
 * Load our helper functions without polluting the .module file.
 */
module_load_include('inc', 'group', 'helpers/entity.group');
module_load_include('inc', 'group', 'helpers/entity.group_membership');
module_load_include('inc', 'group', 'helpers/entity.group_role');
module_load_include('inc', 'group', 'helpers/entity.group_type');
module_load_include('inc', 'group', 'helpers/group');

/**
 * Implements hook_hook_info().
 *
 * Makes sure this module automatically finds exported Group
 * entities in files using the module.group.inc name pattern.
 */
function group_hook_info() {
  $hooks['default_group_type'] = array(
    'group' => 'group',
  );

  $hooks['default_group_role'] = array(
    'group' => 'group',
  );

  return $hooks;
}

/**
 * Implements hook_entity_info().
 *
 * Defines the entities this module needs to function.
 */
function group_entity_info() {
  $info['group'] = array(
    'label' => t('Group'),
    'plural label' => t('Groups'),
    'description' => t('Groups people and content with roles and permissions.'),
    'entity class' => 'Group',
    'controller class' => 'GroupController',
    'base table' => 'groups',
    'fieldable' => TRUE,
    'entity keys' => array(
      'id' => 'gid',
      'bundle' => 'type',
      'label' => 'title',
    ),
    'access callback' => 'group_entity_access',
    'label callback' => 'entity_class_label',
    'uri callback' => 'entity_class_uri',
    'bundles' => array(),
    'bundle keys' => array(
      'bundle' => 'name',
    ),
    'module' => 'group',
    'admin ui' => array(
      'path' => 'admin/group',
      'file' => 'forms/group.inc',
      'controller class' => 'GroupUIController',
    ),
  );

  $info['group_type'] = array(
    'label' => t('Group type'),
    'plural label' => t('Group types'),
    'description' => t('Define different group types.'),
    'entity class' => 'GroupType',
    'controller class' => 'GroupTypeController',
    'base table' => 'group_type',
    'fieldable' => FALSE,
    'bundle of' => 'group',
    'exportable' => TRUE,
    'entity keys' => array(
      'id' => 'tid',
      'name' => 'name',
      'label' => 'label',
    ),
    'access callback' => 'group_type_access',
    'module' => 'group',
    'admin ui' => array(
      'path' => 'admin/group/type',
      'file' => 'admin/group_type.inc',
      'controller class' => 'GroupTypeUIController',
    ),
    'features controller class' => 'GroupTypeFeaturesController',
  );

  $info['group_role'] = array(
    'label' => t('Group role'),
    'plural label' => t('Group roles'),
    'description' => t('Define different group roles.'),
    'entity class' => 'GroupRole',
    'controller class' => 'GroupRoleController',
    'base table' => 'group_role',
    'fieldable' => FALSE,
    'exportable' => TRUE,
    'entity keys' => array(
      'id' => 'rid',
      'name' => 'name',
      'label' => 'label',
    ),
    // Roles are bound to group types.
    'access callback' => 'group_type_access',
    'module' => 'group',
    'admin ui' => array(
      'path' => 'admin/group/role',
      'file' => 'admin/group_role.inc',
      'controller class' => 'GroupRoleUIController',
    ),
    'features controller class' => 'GroupRoleFeaturesController',
  );

  $info['group_membership'] = array(
    'label' => t('Group membership'),
    'plural label' => t('Group memberships'),
    'description' => t('Provides functionality to link Group to User entities.'),
    'entity class' => 'GroupMembership',
    'controller class' => 'GroupMembershipController',
    'base table' => 'group_membership',
    'entity keys' => array(
      'id' => 'mid',
    ),
    'module' => 'group',
  );

  return $info;
}

/**
 * Implements hook_entity_info_alter().
 *
 * Informs Drupal that our group types are bundles for groups.
 */
function group_entity_info_alter(&$entity_info) {
  foreach (group_types() as $name => $group_type) {
    $entity_info['group']['bundles'][$name] = array(
      'label' => $group_type->label,
      'admin' => array(
        'path' => 'admin/group/type/manage/%group_type',
        'real path' => 'admin/group/type/manage/' . $name,
        'bundle argument' => 4,
        'access arguments' => array('administer group types'),
      ),
    );
  }
}

/**
 * Implements hook_entity_property_info().
 */
function group_entity_property_info() {
  $info = array();

  // Properties for Group entities.
  $group = &$info['group']['properties'];
  $group['gid'] = array(
    'label' => t('Group ID'),
    'description' => t('The unique group ID.'),
    'type' => 'integer',
    'schema_field' => 'gid',
  );

  $group['type'] = array(
    'label' => t('Group type name'),
    'description' => t('The name of the group type.'),
    'type' => 'token',
    'setter callback' => 'entity_property_verbatim_set',
    'clear' => array('group_type'),
    'schema_field' => 'type',
  );

  $group['group_type'] = array(
    'label' => t('Group type'),
    'description' => t('The group type.'),
    'type' => 'group_type',
    'getter callback' => 'group_get_properties',
    'setter callback' => 'group_set_properties',
    'computed' => TRUE,
    'clear' => array('type'),
  );

  $group['title'] = array(
    'label' => t('Title'),
    'description' => t('The title of the group.'),
    'type' => 'text',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'title',
  );

  // Properties for GroupType entities.
  $group_type = &$info['group_type']['properties'];
  $group_type['tid'] = array(
    'label' => t('Group type ID'),
    'description' => t('The unique group type ID.'),
    'type' => 'integer',
    'schema_field' => 'tid',
  );

  $group_type['name'] = array(
    'label' => t('Machine name'),
    'description' => t('The machine readable name for the type.'),
    'type' => 'token',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'name',
  );

  $group_type['label'] = array(
    'label' => t('Label'),
    'description' => t('The human readable name for the type.'),
    'type' => 'text',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'label',
  );

  $group_type['outsider_permissions'] = array(
    'label' => t('Outsider permissions'),
    'description' => t('The outsider permissions for the group type.'),
    'type' => 'list<text>',
    'setter callback' => 'entity_property_verbatim_set',
    //'options list' => '',
  );

  $group_type['member_permissions'] = array(
    'label' => t('Member permissions'),
    'description' => t('The member permissions for the group type.'),
    'type' => 'list<text>',
    'setter callback' => 'entity_property_verbatim_set',
    //'options list' => '',
  );

  $group_type['weight'] = array(
    'label' => t('Weight'),
    'description' => t('The weight of the type compared to others.'),
    'type' => 'integer',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'weight',
  );

  $group_type['status'] = array(
    'label' => t('Entity status'),
    'description' => t('The entity status of the type.'),
    'type' => 'integer',
    'schema_field' => 'status',
  );

  $group_type['module'] = array(
    'label' => t('Providing module'),
    'description' => t('The module providing the entity.'),
    'type' => 'text',
    'schema_field' => 'module',
  );

  // Properties for GroupRole entities.
  $group_role = &$info['group_role']['properties'];
  $group_role['rid'] = array(
    'label' => t('Group role ID'),
    'description' => t('The unique group role ID.'),
    'type' => 'integer',
    'schema_field' => 'rid',
  );

  $group_role['type'] = array(
    'label' => t('Group type name'),
    'description' => t('The name of the group type the role is coupled to.'),
    'type' => 'token',
    'setter callback' => 'entity_property_verbatim_set',
    'clear' => array('group_type'),
    'schema_field' => 'type',
  );

  $group_role['group_type'] = array(
    'label' => t('Group type'),
    'description' => t('The group type the role is coupled to.'),
    'type' => 'group_type',
    'getter callback' => 'group_get_properties',
    'setter callback' => 'group_set_properties',
    'computed' => TRUE,
    'clear' => array('type'),
  );

  $group_role['name'] = array(
    'label' => t('Machine name'),
    'description' => t('The machine readable name for the role.'),
    'type' => 'token',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'name',
  );

  $group_role['label'] = array(
    'label' => t('Label'),
    'description' => t('The human readable name for the role.'),
    'type' => 'text',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'label',
  );

  $group_role['global'] = array(
    'label' => t('Global status'),
    'description' => t('Whether the role is global or not.'),
    'type' => 'boolean',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'global',
  );

  $group_role['permissions'] = array(
    'label' => t('Permissions'),
    'description' => t('The permissions for the role.'),
    'type' => 'list<text>',
    'setter callback' => 'entity_property_verbatim_set',
    //'options list' => '',
  );

  $group_role['weight'] = array(
    'label' => t('Weight'),
    'description' => t('The weight of the role compared to others.'),
    'type' => 'integer',
    'setter callback' => 'entity_property_verbatim_set',
    'schema_field' => 'weight',
  );

  $group_role['status'] = array(
    'label' => t('Entity status'),
    'description' => t('The entity status of the role.'),
    'type' => 'integer',
    'schema_field' => 'status',
  );

  $group_role['module'] = array(
    'label' => t('Providing module'),
    'description' => t('The module providing the entity.'),
    'type' => 'text',
    'schema_field' => 'module',
  );

  // Properties for GroupMembership entities.
  $group_membership = &$info['group_membership']['properties'];
  $group_membership['mid'] = array(
    'label' => t('Group membership ID'),
    'description' => t('The unique group membership ID.'),
    'type' => 'integer',
    'schema_field' => 'mid',
  );

  $group_membership['gid'] = array(
    'label' => t('Group ID'),
    'description' => t('The ID of the group the membership belongs to.'),
    'type' => 'integer',
    'setter callback' => 'entity_property_verbatim_set',
    'clear' => array('group'),
    'schema field' => 'gid',
  );

  $group_membership['group'] = array(
    'label' => t('Group'),
    'description' => t('The group the membership belongs to.'),
    'type' => 'group',
    'getter callback' => 'group_get_properties',
    'setter callback' => 'group_set_properties',
    'computed' => TRUE,
    'clear' => array('gid'),
  );

  $group_membership['uid'] = array(
    'label' => t('User ID'),
    'description' => t('The ID of the user the membership belongs to.'),
    'type' => 'integer',
    'setter callback' => 'entity_property_verbatim_set',
    'clear' => array('user'),
    'schema_field' => 'uid',
  );

  $group_membership['user'] = array(
    'label' => t('User'),
    'description' => t('The user the membership belongs to.'),
    'type' => 'user',
    'getter callback' => 'group_get_properties',
    'setter callback' => 'group_set_properties',
    'computed' => TRUE,
    'clear' => array('uid'),
  );

  $group_membership['roles'] = array(
    'label' => t('Roles'),
    'description' => t('The group roles for the membership.'),
    'type' => 'list<group_role>',
    //'options list' => '',
  );

  return $info;
}

/**
 * Callback for getting only-in-code group properties.
 */
function group_get_properties($data, $options, $name, $type, $info) {
  switch ($name) {
    case 'group':
      return $data->gid;
    case 'group_type':
      return $data->type;
    case 'user':
      return $data->uid;
  }
}

/**
 * Callback for setting only-in-code group properties.
 */
function group_set_properties(&$data, $name, $value, $langcode, $type, $info) {
  switch ($name) {
    case 'group':
      $data->gid = $value;
      break;
    case 'group_type':
      $data->type = $value;
      break;
    case 'user':
      $data->uid = $value;
      break;
  }
}

/**
 * Implements hook_theme().
 */
function group_theme() {
  $theme['group_permission_description'] = array(
    'variables' => array(
      'permission' => NULL,
      'hide' => NULL,
    ),
    'file' => 'theme/group.permission.inc',
  );

  $theme['group_permission_form'] = array(
    'render element' => 'form',
    'file' => 'theme/group.permission.inc',
  );

  return $theme;
}

/**
 * Implements hook_menu().
 */
function group_menu() {
  $items['admin/config/people/group'] = array(
    'title' => 'Group settings',
    'description' => 'Configure the Group module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('group_config_form'),
    'access callback' => 'user_access',
    'access arguments' => array('configure group module'),
    'file' => 'admin/group.config.inc',
  );

  return $items;
}

/**
 * Implements hook_group_permission().
 */
function group_group_permission() {
  $permissions = array(
    'administer group' => array(
      'title' => t('Administer group'),
      'description' => t('Administer the group, its users and permissions'),
      'restrict access' => TRUE,
    ),
    'view group' => array(
      'title' => t('View group'),
    ),
    'view members' => array(
      'title' => t('View group members'),
    ),
  );

  return $permissions;
}

/**
 * Implements hook_permission().
 */
function group_permission() {
  $permissions = array(
    'configure group module' => array(
      'title' => t('Configure Group module'),
      'restrict access' => TRUE,
    ),
    'administer group types' => array(
      'title' => t('Administer group types, their roles and permissions'),
      'restrict access' => TRUE,
    ),
    'bypass group access' => array(
      'title' => t('Bypass group access control'),
      'description' => t('View, edit and delete all groups regardless of permission restrictions'),
      'restrict access' => TRUE,
    ),
    'access group overview' => array(
      'title' => t('Access the group overview page'),
    ),
  );

  // Generate standard node permissions for all applicable node types.
  foreach (group_types() as $name => $group_type) {
    $permissions["create $name group"] = array(
      'title' => t('%type_name: Create new group', array('%type_name' => $group_type->label)),
    );
  }

  return $permissions;
}

/**
 * Entity API access callback for groups.
 *
 * @param string $group_type
 *   (optional) The group type to create. Only needs to be specified
 *   when $op is 'create'.
 */
function group_entity_access($op, $group, $account = NULL, $entity_type = NULL, $group_type = NULL) {
  switch ($op) {
    case 'create':
      return !empty($group_type) && user_access("create $group_type group", $account);
    case 'view':
      return group_access('administer group', $group, $account)
        || group_access('view group', $group, $account);
    case 'update':
    case 'delete':
      return group_access('administer group', $group, $account);
  }
}

/**
 * Access callback: Checks whether the user has permission to add a group.
 */
function _group_add_access() {
  foreach (group_types() as $group_type) {
    if (group_entity_access('create', NULL, NULL, 'group', $group_type->name)) {
      return TRUE;
    }
  }

  if (user_access('administer group types')) {
    // There are no group types defined that the user has permission to create,
    // but the user does have the permission to administer the content types, so
    // grant them access to the page anyway.
    return TRUE;
  }

  return FALSE;
}

/**
 * Access callback: Checks if a role can be added to a group type.
 */
function group_type_add_role_access($group_type) {
  return user_access('administer group types') && !entity_has_status('group_type', $group_type, ENTITY_FIXED);
}

/**
 * Entity API access callback for group types and roles.
 */
function group_type_access($op, $group_type_or_role, $account = NULL, $entity_type = NULL) {
  return user_access('administer group types', $account);
}

/**
 * Implements hook_menu_local_tasks_alter().
 *
 * Adds a local task to admin/group.
 */
function group_menu_local_tasks_alter(&$data, $router_item, $root_path) {
  // Add action link to 'group/add' on 'admin/group' page.
  if ($root_path == 'admin/group') {
    $item = menu_get_item('group/add');

    if ($item['access']) {
      $data['actions']['output'][] = array(
        '#theme' => 'menu_local_action',
        '#link' => $item,
      );
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function group_form_system_themes_admin_form_alter(&$form, &$form_state) {
  $form['admin_theme']['group_admin_theme'] = array(
    '#type' => 'checkbox',
    '#title' => t('Use the administration theme when editing or creating groups'),
    '#default_value' => variable_get('group_admin_theme', '0'),
  );

  $form['#submit'][] = 'group_system_themes_admin_form_submit';
}

/**
 * Extra submit handler for admin theme form.
 */
function group_system_themes_admin_form_submit($form, &$form_state) {
  variable_set('group_admin_theme', $form_state['values']['group_admin_theme']);
}

/**
 * Implements hook_admin_paths().
 */
function group_admin_paths() {
  if (variable_get('group_admin_theme')) {
    $paths = array(
      'group/*/edit' => TRUE,
      'group/*/delete' => TRUE,
      'group/add' => TRUE,
      'group/add/*' => TRUE,
    );

    return $paths;
  }
}

/**
 * Implements hook_group_operations().
 */
function group_group_operations() {
  $operations['delete'] = array(
    'label' => t('Delete selected groups'),
    'callback' => 'group_multiple_delete_confirm',
    'form callback' => TRUE,
  );

  return $operations;
}
